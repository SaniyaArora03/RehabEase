<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha512-DxV+EoADOkOygM4IR9yXP8Sb2qwgidEmeqAEmDKIOfPRQZOWbXCzLC6vjbZyy0vPisbH2SyW27+ddLVCN+OMzQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="/static/style.css">
    <title>My Exercises</title>
</head>
<body>
    <!-- navbar -->
     <nav class="navbar">
        <div class="nav">
            <i class="fa-solid fa-house"></i>
            <p><a href="/index.html">Home</a></p>
        </div>
        <div class="nav">
            <i class="fa-solid fa-dumbbell"></i>
             <p><a href="/myExercise.html">My Exercises</a></p>
        </div>
        <div class="nav">
            <i class="fa-solid fa-bars-progress"></i>
            <p><a href="/myProgress.html">My Progress</a> </p>
        </div>
       
        <div class="nav">
            <i class="fa-solid fa-right-from-bracket"></i>
             <p>Log Out</p>
        </div>
        <div class="streak">
            <i class="fa-solid fa-fire" style="color: #FFD43B;"></i>
            <p>5</p>
        </div>
     </nav>

    <h1 class="heading2">Come On! You got this!</h1>

    <!-- exercise section -->
    <div class="exerciseCard">
        <!-- video -->
        <div id="exerciseContainer">
            <iframe id="exerciseVideo" width="640" height="360" frameborder="0" allowfullscreen></iframe>

             <!-- Webcam detection -->
        <div>
            <h3>Your Webcam</h3>
            <img id="webcamFeed" src="http://127.0.0.1:5001/pose_feed" width="480" height="270" alt="Webcam" />
        </div>

        </div>
        <h2>Knee Stretch</h2>
        <p>Stand straight, bend your knee slowly, hold for 10 seconds, then release.</p>
        <p><strong>Sets/Reps:</strong> 3 × 10</p>
        <button class="exerbutton" id="startExercise">Start Exercise</button>
        <button class="exerbutton" id="stopExercise">Stop Exercise</button>
        
        <!-- feedback -->
        <div class="feedback-placeholder">
            <p class="feedPara"><strong>Status: Waiting to start...</strong></p>
        </div>

        <div class="exercise-list">
            <h3 class="exerHead">Upcoming Exercises</h3>
            <ul id="upcomingList"></ul>
        </div>
    </div>

<script>
  document.addEventListener("DOMContentLoaded", async () => {
    try {
      const token = localStorage.getItem("token");
      const res = await fetch("/api/profile", {
        method: "GET",
        headers: { "Authorization": `Bearer ${token}` }
      });
      //logout
      document.querySelector(".fa-right-from-bracket").addEventListener("click", () => {
    localStorage.removeItem("token"); // remove auth
    window.location.href = "/login.html";
});

      const profile = await res.json();

      // main video
      const exerciseVideo = document.getElementById("exerciseVideo");

      //start on button click
      document.getElementById("startExercise").addEventListener("click", () => {
  document.getElementById("webcamFeed").src = "http://127.0.0.1:5001/pose_feed";
  document.querySelector(".feedPara").innerText = "Status: Exercise Started!";
});
//stop on button click
document.getElementById("stopExercise").addEventListener("click", () => {
  document.getElementById("webcamFeed").src = "";
  document.querySelector(".feedPara").innerText = "Status: Stopped.";
});
//display feedback
setInterval(async () => {
        try {
          const resp = await fetch("http://127.0.0.1:5001/pose_status");
          const data = await resp.json();
          document.querySelector(".feedPara").innerText =
            `Status: ${data.status} | Angle: ${data.angle}° | Reps: ${data.reps}`;
        } catch (err) {
          console.error("Error fetching pose status:", err);
        }
      }, 1000);



      if (profile.videos && profile.videos.length > 0) {
        // Convert first video to embed and set as main video
        let embedUrl = profile.videos[0].replace("watch?v=", "embed/").split("&")[0];
        exerciseVideo.src = embedUrl;

        //  upcoming list
        const upcomingList = document.getElementById("upcomingList");
        upcomingList.innerHTML = "";

        profile.videos.slice(1).forEach(videoUrl => {
          let embedUrl = videoUrl.replace("watch?v=", "embed/").split("&")[0];
          const li = document.createElement("li");
          li.innerHTML = `<iframe width="280" height="157" src="${embedUrl}" frameborder="0" allowfullscreen></iframe>`;
          upcomingList.appendChild(li);
        });
      } else {
        exerciseVideo.src = "";
        document.getElementById("upcomingList").innerHTML = "<p>No upcoming exercises</p>";
      }
    } catch (err) {
      console.error("Error loading profile:", err);
    }
  });
</script>
</body>
</html>